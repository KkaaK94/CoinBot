#!/usr/bin/env python3
"""
íŠ¸ë ˆì´ë”© ë´‡ ë©”ì¸ ì‹¤í–‰ íŒŒì¼
- ëª¨ë“  ì»´í¬ë„ŒíŠ¸ í†µí•©
- ì•ˆì „ ëª¨ë“œ ì§€ì›
- ì‹ í˜¸ ì²˜ë¦¬
- ì˜ˆì™¸ ì²˜ë¦¬
"""

import os
import sys
import signal
import argparse
import asyncio
import logging
import time
from datetime import datetime
from pathlib import Path

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ Python ê²½ë¡œì— ì¶”ê°€
PROJECT_ROOT = Path(__file__).parent
sys.path.insert(0, str(PROJECT_ROOT))

# ì„¤ì • ë¨¼ì € ë¡œë“œ
from config.settings import Settings, init_settings, get_default_settings
from core.data_collector import DataCollector
from core.analyzer import Analyzer
from core.strategy_engine import StrategyEngine
from core.trader import Trader
from core.risk_manager import RiskManager
from utils.logger import setup_logger
from utils.telegram_bot import TelegramBot
from utils.database import Database
from learning.performance_tracker import PerformanceTracker

class TradingBot:
    """í†µí•© íŠ¸ë ˆì´ë”© ë´‡ í´ë˜ìŠ¤"""
    
    def __init__(self, safe_mode: bool = False):
        """íŠ¸ë ˆì´ë”© ë´‡ ì´ˆê¸°í™”"""
        self.safe_mode = safe_mode
        self.running = False
        self.start_time = datetime.now()
        
        print(f"ğŸ¯ íŠ¸ë ˆì´ë”© ë´‡ ì´ˆê¸°í™” ì‹œì‘ - ëª¨ë“œ: {'ğŸ›¡ï¸ ì•ˆì „' if safe_mode else 'ğŸ’° ì‹¤ì œê±°ë˜'}")
        
        # ì„¤ì • ì´ˆê¸°í™”
        try:
            self.settings = init_settings(safe_mode=safe_mode)
            print("âœ… ì„¤ì • ë¡œë“œ ì™„ë£Œ")
        except Exception as e:
            print(f"âŒ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: {e}")
            raise
        
        # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
        log_dir = Path("logs")
        log_dir.mkdir(exist_ok=True)
        
        # ë¡œê¹… ì„¤ì •
        try:
            self.logger = setup_logger(
                name="TradingBot",
                level=self.settings.system.log_level,
                log_file=self.settings.system.log_file
            )
            print("âœ… ë¡œê¹… ì„¤ì • ì™„ë£Œ")
        except Exception as e:
            print(f"âŒ ë¡œê¹… ì„¤ì • ì‹¤íŒ¨: {e}")
            # ê¸°ë³¸ ë¡œê¹… ì„¤ì •
            logging.basicConfig(level=logging.INFO)
            self.logger = logging.getLogger("TradingBot")
        
        # ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™”
        self.initialize_components()
        
        # ì‹ í˜¸ í•¸ë“¤ëŸ¬ ë“±ë¡
        signal.signal(signal.SIGINT, self.signal_handler)
        signal.signal(signal.SIGTERM, self.signal_handler)
        
        self.logger.info(f"íŠ¸ë ˆì´ë”© ë´‡ ì´ˆê¸°í™” ì™„ë£Œ - ëª¨ë“œ: {'ì•ˆì „' if safe_mode else 'ì‹¤ì œê±°ë˜'}")
        print("ğŸš€ íŠ¸ë ˆì´ë”© ë´‡ ì´ˆê¸°í™” ì™„ë£Œ!")
    
    def initialize_components(self):
        """ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™”"""
        try:
            print("ğŸ“¦ ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì¤‘...")
            
            # ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
            try:
                self.database = Database()
                print("âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ")
            except Exception as e:
                print(f"âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
                self.database = None
            
            # í…”ë ˆê·¸ë¨ ë´‡ ì´ˆê¸°í™”
            try:
                if self.settings.api.telegram_bot_token and self.settings.api.telegram_chat_id:
                    self.telegram_bot = TelegramBot(
                        token=self.settings.api.telegram_bot_token,
                        chat_id=self.settings.api.telegram_chat_id
                    )
                    print("âœ… í…”ë ˆê·¸ë¨ ë´‡ ì´ˆê¸°í™” ì™„ë£Œ")
                else:
                    self.telegram_bot = None
                    print("âš ï¸ í…”ë ˆê·¸ë¨ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤")
            except Exception as e:
                print(f"âš ï¸ í…”ë ˆê·¸ë¨ ë´‡ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
                self.telegram_bot = None
            
            # í•µì‹¬ ì»´í¬ë„ŒíŠ¸ë“¤
            try:
                self.data_collector = DataCollector()
                print("âœ… ë°ì´í„° ìˆ˜ì§‘ê¸° ì´ˆê¸°í™” ì™„ë£Œ")
            except Exception as e:
                print(f"âŒ ë°ì´í„° ìˆ˜ì§‘ê¸° ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
                raise
            
            try:
                self.analyzer = Analyzer()
                print("âœ… ë¶„ì„ê¸° ì´ˆê¸°í™” ì™„ë£Œ")
            except Exception as e:
                print(f"âŒ ë¶„ì„ê¸° ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
                raise
            
            try:
                self.strategy_engine = StrategyEngine()
                print("âœ… ì „ëµ ì—”ì§„ ì´ˆê¸°í™” ì™„ë£Œ")
            except Exception as e:
                print(f"âŒ ì „ëµ ì—”ì§„ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
                raise
            
            try:
                self.risk_manager = RiskManager()
                print("âœ… ë¦¬ìŠ¤í¬ ê´€ë¦¬ì ì´ˆê¸°í™” ì™„ë£Œ")
            except Exception as e:
                print(f"âŒ ë¦¬ìŠ¤í¬ ê´€ë¦¬ì ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
                raise
            
            try:
                self.trader = Trader(safe_mode=self.safe_mode)
                print("âœ… íŠ¸ë ˆì´ë” ì´ˆê¸°í™” ì™„ë£Œ")
            except Exception as e:
                print(f"âŒ íŠ¸ë ˆì´ë” ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
                raise
            
            try:
                self.performance_tracker = PerformanceTracker()
                print("âœ… ì„±ëŠ¥ ì¶”ì ê¸° ì´ˆê¸°í™” ì™„ë£Œ")
            except Exception as e:
                print(f"âš ï¸ ì„±ëŠ¥ ì¶”ì ê¸° ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
                self.performance_tracker = None
            
            print("ğŸ‰ ëª¨ë“  ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì™„ë£Œ!")
            
        except Exception as e:
            print(f"âŒ ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            if hasattr(self, 'logger'):
                self.logger.error(f"ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            raise
    
    def signal_handler(self, signum, frame):
        """ì‹ í˜¸ í•¸ë“¤ëŸ¬"""
        signal_names = {
            signal.SIGINT: "SIGINT (Ctrl+C)",
            signal.SIGTERM: "SIGTERM"
        }
        
        signal_name = signal_names.get(signum, f"Signal {signum}")
        print(f"\nğŸ“¨ {signal_name} ì‹ í˜¸ ìˆ˜ì‹  - ë´‡ ì¢…ë£Œ ì¤‘...")
        
        if hasattr(self, 'logger'):
            self.logger.info(f"ì‹ í˜¸ {signal_name} ìˆ˜ì‹  - ë´‡ ì¢…ë£Œ ì¤‘...")
        
        self.stop()
    
    async def send_startup_message(self):
        """ì‹œì‘ ë©”ì‹œì§€ ë°œì†¡"""
        if self.telegram_bot:
            try:
                uptime = datetime.now() - self.start_time
                message = f"""
ğŸ¯ **íŠ¸ë ˆì´ë”© ë´‡ ì‹œì‘**

ğŸ“Š **ì„¤ì • ì •ë³´**
â€¢ ëª¨ë“œ: {'ğŸ›¡ï¸ ì•ˆì „ ëª¨ë“œ (ëª¨ì˜ê±°ë˜)' if self.safe_mode else 'ğŸ’° ì‹¤ì œ ê±°ë˜ ëª¨ë“œ'}
â€¢ ê±°ë˜ ê¸ˆì•¡: {self.settings.trading.trade_amount:,}ì›
â€¢ ìµœëŒ€ í¬ì§€ì…˜: {self.settings.trading.max_position_size:,}ì›
â€¢ ì†ì ˆë§¤: {self.settings.trading.stop_loss_percent}%
â€¢ ìµì ˆ: {self.settings.trading.take_profit_percent}%
â€¢ ëŒ€ìƒ ì½”ì¸: {len(self.settings.trading.target_coins)}ê°œ

ğŸ“ˆ **ëŒ€ìƒ ì½”ì¸ ëª©ë¡**
{', '.join(self.settings.trading.target_coins)}

â° **ì‹œì‘ ì‹œê°„**: {self.start_time.strftime('%Y-%m-%d %H:%M:%S')}

ğŸš€ **ë´‡ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!**

{f'âš ï¸ ì•ˆì „ ëª¨ë“œì—ì„œëŠ” ì‹¤ì œ ê±°ë˜ê°€ ì´ë£¨ì–´ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.' if self.safe_mode else 'ğŸ’° ì‹¤ì œ ê±°ë˜ê°€ ì‹œì‘ë©ë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ ëª¨ë‹ˆí„°ë§í•˜ì„¸ìš”.'}
"""
                await self.telegram_bot.send_message(message)
                print("ğŸ“± í…”ë ˆê·¸ë¨ ì‹œì‘ ë©”ì‹œì§€ ë°œì†¡ ì™„ë£Œ")
                
            except Exception as e:
                print(f"âš ï¸ í…”ë ˆê·¸ë¨ ì‹œì‘ ë©”ì‹œì§€ ë°œì†¡ ì‹¤íŒ¨: {e}")
                if hasattr(self, 'logger'):
                    self.logger.error(f"ì‹œì‘ ë©”ì‹œì§€ ë°œì†¡ ì‹¤íŒ¨: {e}")
    
    def stop(self):
        """ë´‡ ì¤‘ì§€"""
        print("ğŸ›‘ íŠ¸ë ˆì´ë”© ë´‡ ì¤‘ì§€ ì¤‘...")
        if hasattr(self, 'logger'):
            self.logger.info("íŠ¸ë ˆì´ë”© ë´‡ ì¤‘ì§€ ì¤‘...")
        
        self.running = False
        
        # ì •ë¦¬ ì‘ì—…
        try:
            if hasattr(self, 'database') and self.database:
                self.database.close()
                print("âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¢…ë£Œ")
        except Exception as e:
            print(f"âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜: {e}")
        
        print("âœ… íŠ¸ë ˆì´ë”© ë´‡ ì¤‘ì§€ ì™„ë£Œ")